version: "3.7"
services:
    #PHP Service
    ms-el2:
        build:
            context: .
            dockerfile: Dockerfile
        image: ms-el2/php
        container_name: app-ms-el2
        restart: unless-stopped
        tty: true
        environment:
            SERVICE_NAME: app
            SERVICE_TAGS: dev
        working_dir: /var/www
        volumes:
            - /tmp:/tmp # for php-cs-fixer
            - ./:/var/www
            - ./php/local.ini:/usr/local/etc/php/conf.d/local.ini
        networks:
            - app-ms-el2-network
            - nginxproxyman
            - sqldev-backend
        ports:
            # smtp tls
            #- 217.114.43.138:587:587
            #- 217.114.43.138:2222:22
            # vite node.js server
            - 217.114.43.138:5173:5173

    # Worker Service for Redis
    # docker-compose up -d --scale worker=4
    worker:
        image: ms-el2/php # ← тот же образ
        # container_name: worker-ms-el2 для replicas нельзя свое имя контейнер
        restart: unless-stopped
        working_dir: /var/www
        command: php artisan queue:work redis --sleep=3 --tries=3 --max-time=3600
        deploy:
            replicas: 4 # 4 воркера
        volumes:
            - ./:/var/www
            - ./php/local.ini:/usr/local/etc/php/conf.d/local.ini
        networks:
            - app-ms-el2-network # ← те же сети, что у app
            - sqldev-backend
        depends_on:
            - ms-el2 # service name, а не container_name: app-ms-el2
            - redis # как бы ни назывался ваш redis-сервис в docker-compose

    scheduler:
        image: ms-el2/php
        container_name: ms-el2-scheduler
        restart: unless-stopped
        working_dir: /var/www
        command: >
            bash -c "while true; do
                php artisan schedule:run --verbose;
                sleep 60;
            done"
        volumes:
            - ./:/var/www
            - ./php/local.ini:/usr/local/etc/php/conf.d/local.ini
        networks:
            - app-ms-el2-network
        depends_on:
            - app-ms-el2

    #Nginx Service
    ms-el2-webserver:
        image: nginx:alpine
        container_name: webserver-ms-el2
        restart: unless-stopped
        tty: true
        #ports:
        #    - 217.114.43.138:80:80
        #    - 217.114.43.138:443:443
        volumes:
            - ./:/var/www
            - ./nginx/conf.d/:/etc/nginx/conf.d/
            - ./nginx/snippets/:/etc/nginx/snippets/
            - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
        networks:
            - app-ms-el2-network
            - nginxproxyman

    #MySQL Service
    # db-ms-el2:
    #     image: mysql:8.0.34
    #     container_name: db-ms-el2
    #     restart: unless-stopped
    #     tty: true
    #     ports:
    #         - 127.0.0.1:33356:3306
    #     environment:
    #         MYSQL_DATABASE: ${DB_DATABASE}
    #         MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    #         SERVICE_TAGS: dev
    #         SERVICE_NAME: mysql
    #         APP_DB_USERNAME: ${DB_USERNAME}
    #         APP_DB_PASSWORD: ${DB_PASSWORD}
    #         TZ: Europe/Moscow
    #     volumes:
    #         - dbdata-ms-el2:/var/lib/mysql
    #         - ./mysql/my.cnf:/etc/mysql/my.cnf
    #     networks:
    #         - app-ms-el2-network

    redis:
        image: "redis:alpine"
        container_name: redis-ms-el2
        restart: unless-stopped
        tty: true
        # Connecting at browser
        # redis://username:password@87.251.78.17:6973/0
        # username: default
        # password: ${REDIS_PASSWORD}
        command: redis-server /usr/local/etc/redis/redis.conf --requirepass ${REDIS_PASSWORD}
        ports:
            - 6579:6379
        volumes:
            - redis-ms-el2:/var/lib/redis
            - ./docker/redis/redis.conf:/usr/local/etc/redis/redis.conf
        environment:
            - REDIS_REPLICATION_MODE=master
        networks:
            - app-ms-el2-network

#Docker Networks
networks:
    app-ms-el2-network:
        driver: bridge
    nginxproxyman:
        external: true
        name: nginxproxyman
    sqldev-backend:
        external: true
        name: sqldev-backend

#Volumes
volumes:
    dbdata-ms-el2:
        driver: local
    redis-ms-el2:
        driver: local
        name: redis-ms-el2
